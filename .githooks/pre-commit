#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 hyperpolymath
#
# Pre-commit hook to enforce Hyperpolymath Language Policy
# Blocks: TypeScript, Python, Go, npm/package.json

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Checking Hyperpolymath Language Policy...${NC}"

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
VIOLATIONS=0

for file in $STAGED_FILES; do
    if [[ "$file" =~ \.tsx?$ ]] && [[ ! "$file" =~ \.d\.ts$ ]]; then
        echo -e "${RED}BLOCKED: TypeScript file: $file${NC}"
        echo "  -> Use ReScript (.res) instead"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
    if [[ "$file" =~ \.py$ ]] && [[ ! "$file" =~ (salt|pillar|grain|state|sls) ]]; then
        echo -e "${RED}BLOCKED: Python file: $file${NC}"
        echo "  -> Python only allowed for SaltStack"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
    if [[ "$file" =~ \.go$ ]]; then
        echo -e "${RED}BLOCKED: Go file: $file${NC}"
        echo "  -> Use Rust instead"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
    if [[ "$file" == "package.json" ]] || [[ "$file" =~ /package\.json$ ]]; then
        echo -e "${RED}BLOCKED: package.json: $file${NC}"
        echo "  -> Use deno.json instead"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

if [ $VIOLATIONS -gt 0 ]; then
    echo -e "${RED}COMMIT BLOCKED: $VIOLATIONS violation(s)${NC}"
    exit 1
fi
echo -e "${GREEN}Language policy check passed${NC}"
